#!/usr/bin/env python3
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                               â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                        â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—                       â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘                       â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘                       â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•                       â•‘
â•‘   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•                       â•‘
â•‘                                                                                               â•‘
â•‘            âš”ï¸ WAR BAND ENHANCED - FULL ENHANCEMENT INTEGRATION âš”ï¸                            â•‘
â•‘                                                                                               â•‘
â•‘   ENHANCEMENTS UNIFIED:                                                                       â•‘
â•‘   â”œâ”€â”€ ğŸ† V14 Dance (100% win rate scoring, 1.52% target, no stop loss)                       â•‘
â•‘   â”œâ”€â”€ ğŸŒˆ Rainbow Bridge (emotional frequency alignment)                                       â•‘
â•‘   â”œâ”€â”€ ğŸ”® Synchronicity Decoder (Fibonacci, sacred patterns)                                  â•‘
â•‘   â”œâ”€â”€ ğŸŒ Stargate Grid (global resonance, leyline activity)                                  â•‘
â•‘   â”œâ”€â”€ ğŸ§¬ Mycelium Network (neural coherence, queen signal)                                   â•‘
â•‘   â”œâ”€â”€ ğŸ“Š 7-Day Planner (trained probability windows)                                         â•‘
â•‘   â””â”€â”€ ğŸ”„ Barter Navigator (multi-hop arbitrage paths)                                        â•‘
â•‘                                                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

from aureon_baton_link import link_system as _baton_link; _baton_link(__name__)
import time
import json
import os
import logging
from datetime import datetime
from typing import Dict, List, Any, Optional, Tuple
from dataclasses import dataclass, field

# Core War Band imports
try:
    from aureon_war_band import WarBand
except ImportError:
    WarBand = None

# Enhancement imports
try:
    from aureon_enhancements import EnhancementLayer, EnhancementResult
except ImportError:
    EnhancementLayer = None
    EnhancementResult = None

try:
    from s5_v14_dance_enhancements import V14DanceEnhancer, V14ScoringEngine, V14_CONFIG
except ImportError:
    V14DanceEnhancer = None
    V14ScoringEngine = None
    V14_CONFIG = {'entry_score_threshold': 8, 'profit_target_pct': 1.52}

try:
    from aureon_7day_planner import Aureon7DayPlanner
except ImportError:
    Aureon7DayPlanner = None

try:
    from aureon_barter_navigator import BarterNavigator
except ImportError:
    BarterNavigator = None

logger = logging.getLogger(__name__)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UNIFIED ENHANCEMENT RESULT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@dataclass
class UnifiedEnhancementSignal:
    """Combined signal from all enhancement systems"""
    symbol: str
    exchange: str
    timestamp: datetime = field(default_factory=datetime.now)
    
    # V14 Scoring
    v14_score: int = 0
    v14_threshold: int = 8
    v14_approved: bool = False
    v14_factors: Dict[str, int] = field(default_factory=dict)
    
    # Enhancement Layer
    enhancement_modifier: float = 1.0  # 0.5 - 2.0
    emotional_state: str = ""
    cycle_phase: str = ""
    sync_boost: float = 0.0
    grid_coherence: float = 0.0
    
    # Mycelium Network
    mycelium_score: float = 1.0
    queen_signal: float = 0.0
    network_coherence: float = 0.0
    
    # 7-Day Planner
    planner_window_score: float = 0.0
    is_optimal_window: bool = False
    predicted_gain: float = 0.0
    
    # Barter Navigator
    arbitrage_opportunity: float = 0.0
    best_path_hops: int = 0
    path_effective_rate: float = 1.0
    
    # Combined
    unified_score: float = 0.0
    proceed: bool = False
    reasons: List[str] = field(default_factory=list)
    
    def calculate_unified(self) -> float:
        """Calculate the unified score from all components"""
        scores = []
        weights = []
        
        # V14 Score (normalized to 0-1)
        if self.v14_threshold > 0:
            v14_norm = min(1.0, self.v14_score / (self.v14_threshold * 2))
            scores.append(v14_norm)
            weights.append(3.0)  # High weight - proven 100% win rate
        
        # Enhancement Modifier (normalized from 0.5-2.0 to 0-1)
        enh_norm = (self.enhancement_modifier - 0.5) / 1.5
        scores.append(enh_norm)
        weights.append(2.0)
        
        # Mycelium Score (already 0-1 range)
        scores.append(self.mycelium_score)
        weights.append(2.0)
        
        # Planner Window Score (0-1)
        scores.append(self.planner_window_score)
        weights.append(1.5)
        
        # Arbitrage Opportunity (0-1)
        arb_norm = min(1.0, self.arbitrage_opportunity / 0.02)  # 2% arb = max score
        scores.append(arb_norm)
        weights.append(1.0)
        
        # Grid Coherence (0-1)
        scores.append(self.grid_coherence)
        weights.append(0.5)
        
        # Weighted average
        total_weight = sum(weights)
        if total_weight > 0:
            self.unified_score = sum(s * w for s, w in zip(scores, weights)) / total_weight
        
        # Determine if we should proceed
        # V14 approval is REQUIRED (100% win rate logic)
        # Plus unified score must be > 0.5
        self.proceed = self.v14_approved and self.unified_score > 0.5
        
        return self.unified_score


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ENHANCED WAR BAND
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class EnhancedWarBand:
    """
    âš”ï¸ THE ENHANCED APACHE WAR BAND âš”ï¸
    
    Full integration of all enhancement systems:
    - V14 Dance Enhancements (proven 100% win rate scoring)
    - Rainbow Bridge (emotional frequency mapping)
    - Synchronicity Decoder (Fibonacci/pattern detection)
    - Stargate Grid (global resonance network)
    - Mycelium Network (neural coherence)
    - 7-Day Planner (trained probability windows)
    - Barter Navigator (multi-hop arbitrage)
    """
    
    def __init__(self, war_band=None, client=None, pulse=None):
        """Initialize enhanced war band with all systems"""
        
        print("\n" + "="*80)
        print("âš”ï¸ ENHANCED WAR BAND INITIALIZATION âš”ï¸")
        print("="*80)
        
        # Core war band (wrap existing or create shell)
        if war_band:
            self.war_band = war_band
            print("   âœ… Core War Band: Connected")
        else:
            self.war_band = None
            print("   âš ï¸ Core War Band: Running in standalone mode")
        
        self.client = client
        self.pulse = pulse
        
        # Initialize enhancement systems
        self._init_v14_enhancer()
        self._init_enhancement_layer()
        self._init_7day_planner()
        self._init_barter_navigator()
        
        # Mycelium reference (set externally)
        self._mycelium = None
        
        # Statistics
        self.stats = {
            'signals_evaluated': 0,
            'v14_approved': 0,
            'enhancement_boosted': 0,
            'planner_aligned': 0,
            'arbitrage_found': 0,
            'unified_entries': 0,
            'total_profit': 0.0,
        }
        
        print("="*80)
        print("âš”ï¸ WAR BAND ENHANCED - ALL SYSTEMS OPERATIONAL âš”ï¸")
        print("="*80 + "\n")
    
    def _init_v14_enhancer(self):
        """Initialize V14 Dance Enhancer"""
        if V14DanceEnhancer:
            self.v14_enhancer = V14DanceEnhancer()
            print("   âœ… V14 Dance Enhancer: Ready (100% WR scoring)")
        else:
            self.v14_enhancer = None
            print("   âš ï¸ V14 Dance Enhancer: Not available")
    
    def _init_enhancement_layer(self):
        """Initialize Enhancement Layer (Rainbow, Sync, Stargate)"""
        if EnhancementLayer:
            self.enhancement_layer = EnhancementLayer()
            print("   âœ… Enhancement Layer: Ready (Rainbow + Sync + Stargate)")
        else:
            self.enhancement_layer = None
            print("   âš ï¸ Enhancement Layer: Not available")
    
    def _init_7day_planner(self):
        """Initialize 7-Day Planner"""
        if Aureon7DayPlanner:
            self.planner = Aureon7DayPlanner()
            print("   âœ… 7-Day Planner: Ready (trained probability windows)")
        else:
            self.planner = None
            print("   âš ï¸ 7-Day Planner: Not available")
    
    def _init_barter_navigator(self):
        """Initialize Barter Navigator"""
        if BarterNavigator:
            self.barter_nav = BarterNavigator()
            print("   âœ… Barter Navigator: Ready (multi-hop arbitrage)")
        else:
            self.barter_nav = None
            print("   âš ï¸ Barter Navigator: Not available")
    
    def set_mycelium(self, mycelium) -> None:
        """Wire Mycelium network for neural guidance"""
        self._mycelium = mycelium
        if self.war_band:
            self.war_band.set_mycelium(mycelium)
        print("   ğŸ§¬ Mycelium Network: Connected")
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # UNIFIED SIGNAL GENERATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def evaluate_target(self, symbol: str, exchange: str, 
                        price: float, volume: float = 0,
                        lambda_value: float = 1.0) -> UnifiedEnhancementSignal:
        """
        Evaluate a target using ALL enhancement systems.
        
        Returns unified signal with combined scores and proceed/veto decision.
        """
        self.stats['signals_evaluated'] += 1
        
        signal = UnifiedEnhancementSignal(symbol=symbol, exchange=exchange)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # V14 SCORING (PRIMARY GATE - 100% win rate logic)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if self.v14_enhancer:
            v14_eval = self.v14_enhancer.evaluate_entry(symbol, price, volume)
            signal.v14_score = v14_eval['score']
            signal.v14_threshold = v14_eval['threshold']
            signal.v14_approved = v14_eval['should_enter']
            signal.v14_factors = v14_eval.get('factors', {})
            
            if signal.v14_approved:
                self.stats['v14_approved'] += 1
                signal.reasons.append(f"ğŸ† V14 APPROVED: Score {signal.v14_score}/{signal.v14_threshold}")
            else:
                signal.reasons.append(f"âš ï¸ V14 gate: Score {signal.v14_score} < {signal.v14_threshold}")
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ENHANCEMENT LAYER (Rainbow + Synchronicity + Stargate)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if self.enhancement_layer:
            try:
                # Get network coherence from mycelium if available
                coherence = 0.5
                if self._mycelium:
                    coherence = self._mycelium.get_network_coherence()
                
                enh_result = self.enhancement_layer.get_unified_modifier(
                    lambda_value=lambda_value,
                    coherence=coherence,
                    price=price,
                    volume=volume
                )
                
                signal.enhancement_modifier = enh_result.trading_modifier
                signal.emotional_state = enh_result.emotional_state
                signal.cycle_phase = enh_result.cycle_phase
                signal.sync_boost = enh_result.sync_boost
                signal.grid_coherence = enh_result.grid_coherence
                
                if signal.enhancement_modifier > 1.2:
                    self.stats['enhancement_boosted'] += 1
                    signal.reasons.append(f"ğŸŒˆ Enhancement BOOST: {signal.enhancement_modifier:.2f}x ({signal.emotional_state})")
                elif signal.enhancement_modifier < 0.8:
                    signal.reasons.append(f"âš ï¸ Enhancement CAUTION: {signal.enhancement_modifier:.2f}x ({signal.emotional_state})")
            except Exception as e:
                logger.warning(f"Enhancement layer error: {e}")
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # MYCELIUM NETWORK (Neural coherence, Queen signal)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if self._mycelium:
            try:
                mem = self._mycelium.get_symbol_memory(symbol)
                friction = self._mycelium.get_exchange_friction(exchange)
                queen = self._mycelium.get_queen_signal()
                coherence = self._mycelium.get_network_coherence()
                
                wr = float(mem.get('win_rate', 0.5))
                act = float(mem.get('activation', 0.5))
                friction_penalty = 1.0 - min(0.5, friction.get('reject_count', 0) * 0.05)
                queen_factor = 1.0 + 0.15 * queen
                coh_factor = 0.6 + 0.4 * coherence
                
                signal.mycelium_score = wr * act * friction_penalty * queen_factor * coh_factor
                signal.queen_signal = queen
                signal.network_coherence = coherence
                
                if signal.mycelium_score > 0.7:
                    signal.reasons.append(f"ğŸ§¬ Mycelium STRONG: {signal.mycelium_score:.2f} (Queen: {queen:.2f})")
            except Exception as e:
                logger.warning(f"Mycelium error: {e}")
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 7-DAY PLANNER (Trained probability windows)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if self.planner:
            try:
                now = datetime.now()
                hour = now.hour
                day = now.weekday()
                
                # Get hourly edge from trained matrix
                hourly_edges = self.planner.probability_matrix.get('hour_day_edge', {})
                key = f"h{hour:02d}_d{day}"
                edge_data = hourly_edges.get(key, {})
                
                avg_gain = edge_data.get('avg_gain', 0)
                confidence = edge_data.get('confidence', 0)
                
                # Normalize to 0-1 score
                signal.planner_window_score = min(1.0, max(0, (avg_gain + 5) / 10))  # -5% to +5% -> 0-1
                signal.is_optimal_window = avg_gain > 1.0 and confidence > 0.6
                signal.predicted_gain = avg_gain
                
                if signal.is_optimal_window:
                    self.stats['planner_aligned'] += 1
                    signal.reasons.append(f"ğŸ“Š Optimal Window: +{avg_gain:.2f}% predicted")
            except Exception as e:
                logger.warning(f"Planner error: {e}")
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # BARTER NAVIGATOR (Multi-hop arbitrage)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if self.barter_nav:
            try:
                # Check for arbitrage opportunities from this symbol
                base = symbol.replace('USDT', '').replace('USD', '').replace('/', '')
                opportunities = self.barter_nav.find_arbitrage(base, max_hops=4, min_profit_pct=0.5)
                
                if opportunities:
                    best = opportunities[0]
                    signal.arbitrage_opportunity = best.profit_pct / 100  # Convert to decimal
                    signal.best_path_hops = best.hops
                    signal.path_effective_rate = best.effective_rate
                    
                    self.stats['arbitrage_found'] += 1
                    signal.reasons.append(f"ğŸ”„ Arbitrage: +{best.profit_pct:.2f}% via {best.hops} hops")
            except Exception as e:
                logger.warning(f"Barter navigator error: {e}")
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # CALCULATE UNIFIED SCORE
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        signal.calculate_unified()
        
        if signal.proceed:
            self.stats['unified_entries'] += 1
            signal.reasons.insert(0, f"âœ… UNIFIED APPROVED: {signal.unified_score:.2f}")
        else:
            signal.reasons.insert(0, f"âŒ UNIFIED BLOCKED: {signal.unified_score:.2f}")
        
        return signal
    
    def get_top_targets(self, candidates: List[Dict], top_n: int = 5) -> List[Tuple[Dict, UnifiedEnhancementSignal]]:
        """
        Evaluate multiple candidates and return top N by unified score.
        
        candidates: List of {'symbol': str, 'exchange': str, 'price': float, 'volume': float}
        """
        scored = []
        
        for c in candidates:
            signal = self.evaluate_target(
                symbol=c.get('symbol', ''),
                exchange=c.get('exchange', 'kraken'),
                price=c.get('price', 0),
                volume=c.get('volume', 0),
                lambda_value=c.get('lambda', 1.0)
            )
            scored.append((c, signal))
        
        # Sort by unified score, descending
        scored.sort(key=lambda x: x[1].unified_score, reverse=True)
        
        # Filter to only those that pass V14 gate
        approved = [(c, s) for c, s in scored if s.v14_approved]
        
        return approved[:top_n]
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # POSITION MANAGEMENT (V14 Enhanced)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def check_exit(self, symbol: str, current_price: float) -> Dict:
        """
        Check exit using V14 rules: ONLY at 1.52%+ profit, NO stop loss.
        """
        if self.v14_enhancer:
            return self.v14_enhancer.check_exit(symbol, current_price)
        
        # Fallback if V14 not available
        return {'should_exit': False, 'reason': 'V14 enhancer not available'}
    
    def get_profit_target(self) -> float:
        """Get V14 profit target (1.52%)"""
        return V14_CONFIG.get('profit_target_pct', 1.52)
    
    def uses_stop_loss(self) -> bool:
        """V14 CRITICAL: No stop loss - hold until profit"""
        return False
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STATUS & REPORTING
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def display_status(self):
        """Display comprehensive status"""
        print("\n" + "="*80)
        print("âš”ï¸ ENHANCED WAR BAND STATUS")
        print("="*80)
        
        print("\nğŸ“Š ENHANCEMENT SYSTEMS:")
        print(f"   V14 Dance:      {'âœ… Active' if self.v14_enhancer else 'âŒ Inactive'}")
        print(f"   Enhancement:    {'âœ… Active' if self.enhancement_layer else 'âŒ Inactive'}")
        print(f"   Mycelium:       {'âœ… Connected' if self._mycelium else 'âŒ Not connected'}")
        print(f"   7-Day Planner:  {'âœ… Active' if self.planner else 'âŒ Inactive'}")
        print(f"   Barter Nav:     {'âœ… Active' if self.barter_nav else 'âŒ Inactive'}")
        
        print("\nğŸ“ˆ STATISTICS:")
        print(f"   Signals Evaluated: {self.stats['signals_evaluated']}")
        print(f"   V14 Approved:      {self.stats['v14_approved']}")
        print(f"   Enhancement Boost: {self.stats['enhancement_boosted']}")
        print(f"   Planner Aligned:   {self.stats['planner_aligned']}")
        print(f"   Arbitrage Found:   {self.stats['arbitrage_found']}")
        print(f"   Unified Entries:   {self.stats['unified_entries']}")
        print(f"   Total Profit:      ${self.stats['total_profit']:.2f}")
        
        print("\nğŸ† V14 RULES (100% WIN RATE):")
        print(f"   Entry Threshold:   Score {V14_CONFIG.get('entry_score_threshold', 8)}+")
        print(f"   Profit Target:     {V14_CONFIG.get('profit_target_pct', 1.52)}%")
        print(f"   Stop Loss:         NONE (hold until profit)")
        
        # Enhancement layer details
        if self.enhancement_layer:
            print("\nğŸŒˆ ENHANCEMENT LAYER STATUS:")
            self.enhancement_layer.display_status()
        
        print("="*80 + "\n")
    
    def get_stats(self) -> Dict:
        """Get all stats as dictionary"""
        return {
            'war_band_enhanced': True,
            'systems': {
                'v14_dance': self.v14_enhancer is not None,
                'enhancement_layer': self.enhancement_layer is not None,
                'mycelium': self._mycelium is not None,
                'planner_7day': self.planner is not None,
                'barter_navigator': self.barter_nav is not None,
            },
            'stats': self.stats.copy(),
            'v14_config': V14_CONFIG,
        }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INTEGRATION HELPER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def enhance_war_band(war_band=None, 
                     client=None, 
                     pulse=None,
                     mycelium=None) -> EnhancedWarBand:
    """
    Factory function to create an Enhanced War Band.
    
    Can wrap an existing WarBand or create standalone.
    """
    enhanced = EnhancedWarBand(war_band=war_band, client=client, pulse=pulse)
    
    if mycelium:
        enhanced.set_mycelium(mycelium)
    
    return enhanced


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STANDALONE TEST
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                               â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                        â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—                       â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘                       â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘                       â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•                       â•‘
â•‘   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•                       â•‘
â•‘                                                                                               â•‘
â•‘                    âš”ï¸ WAR BAND ENHANCED - TEST MODE âš”ï¸                                       â•‘
â•‘                                                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
    
    # Create enhanced war band (standalone mode)
    enhanced = EnhancedWarBand()
    
    # Test with sample targets
    print("\nğŸ¯ EVALUATING TEST TARGETS...")
    print("-" * 60)
    
    test_targets = [
        {'symbol': 'BTCUSDT', 'exchange': 'binance', 'price': 67500.0, 'volume': 1500000000},
        {'symbol': 'ETHUSDT', 'exchange': 'binance', 'price': 3520.0, 'volume': 800000000},
        {'symbol': 'SOLUSD', 'exchange': 'kraken', 'price': 172.0, 'volume': 50000000},
        {'symbol': 'XRPUSD', 'exchange': 'kraken', 'price': 0.55, 'volume': 100000000},
        {'symbol': 'DOGEUSDT', 'exchange': 'binance', 'price': 0.155, 'volume': 200000000},
    ]
    
    # Feed some price history to V14 scoring engine
    if enhanced.v14_enhancer:
        import numpy as np
        for t in test_targets:
            base_price = t['price']
            for i in range(35):
                # Simulate declining then recovering prices (buy opportunity pattern)
                price = base_price * (0.95 + i * 0.002 + np.random.uniform(-0.005, 0.005))
                vol = t['volume'] * (1 + np.random.uniform(-0.2, 0.5))
                enhanced.v14_enhancer.scoring_engine.update_price_history(t['symbol'], price, vol)
    
    # Evaluate each target
    for t in test_targets:
        signal = enhanced.evaluate_target(
            symbol=t['symbol'],
            exchange=t['exchange'],
            price=t['price'],
            volume=t['volume']
        )
        
        status = "âœ… PROCEED" if signal.proceed else "âŒ BLOCKED"
        print(f"\n{t['symbol']} ({t['exchange']}) @ ${t['price']:.4f}")
        print(f"   Status: {status}")
        print(f"   Unified Score: {signal.unified_score:.3f}")
        print(f"   V14 Score: {signal.v14_score}/{signal.v14_threshold} {'âœ“' if signal.v14_approved else 'âœ—'}")
        print(f"   Enhancement: {signal.enhancement_modifier:.2f}x ({signal.emotional_state or 'N/A'})")
        print(f"   Planner Window: {'OPTIMAL' if signal.is_optimal_window else 'Normal'} ({signal.predicted_gain:+.2f}%)")
        
        if signal.reasons:
            print(f"   Reasons:")
            for r in signal.reasons[:3]:
                print(f"      â€¢ {r}")
    
    # Display full status
    enhanced.display_status()
    
    print("\nğŸ† ENHANCED WAR BAND READY FOR DEPLOYMENT!")
    print("   from aureon_war_band_enhanced import EnhancedWarBand, enhance_war_band")
